<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Biz Tycoon</title>
    <link rel="shortcut icon" href="TemplateData/sign.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">

    <!-- Socket server init -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.js"></script>

    <!-- Ads initialization -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script>
        const AdController = window.Adsgram.init({
            blockId: "5717",
            debug: true,
            debugBannerType: "RewardedVideo"
        });
    </script>

    <!-- CSS settings -->
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #000;
            color-scheme: only light;
        }

        #unity-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        canvas {
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        #unity-loading-bar {
            background-color: black;
        }

        #custom-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            z-index: 9999;
            display: none;
        }

        #spinning-truck {
            position: absolute;
            top: 33%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            z-index: 10000;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(-360deg);
            }
        }

        #loader-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            text-align: center;
            z-index: 10000;
        }

        #unity-logo {
            display: none !important;
        }
    </style>

    <!-- Telegram init -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        window.Telegram.WebApp.expand();
        function expandMiniApp() {
            console.log("Expanding Mini App...");
            if (window.TelegramWebviewProxy) {
                window.TelegramWebviewProxy.postEvent('web_app_expand', JSON.stringify({}));
                window.Telegram.WebApp.expand();
            } else if (window.parent) {
                const data = JSON.stringify({
                    eventType: 'web_app_expand',
                    eventData: {}
                });
                window.parent.postEvent('web_app_expand');
            }
        }

        window.addEventListener('load', function () {
            setTimeout(expandMiniApp, 10);
        });
    </script>
</head>

<!-- Loading screen body -->

<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">motchi</div>
        </div>
    </div>

    <div id="custom-overlay">
        <!--<img id="truck-icon" src="TemplateData/TRUCK_Icon.png" alt="Truck Icon">-->
    </div>

    <img id="spinning-truck" src="TemplateData/LoadingScreen/CIRCLE_Money_.png" alt="Spinning Truck Icon">

    <div id="loader-text">
        Loadingüêå
    </div>

    <!-- <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="custom-overlay">
                <img id="characted-background" src="TemplateData/LoadingScreen/CIRCLE_.png">
                <div id="character-container">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_1.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_2.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_3.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_4A.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_1.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_2.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_3.png">
                    <img class="character-sprite" src="TemplateData/LoadingScreen/WALK_4B.png">
                </div>
                <div id="load-text">
                    Loading
                </div>
                <img class="spinning-load-sprite" src="TemplateData/LoadingScreen/CIRCLE_Money_.png">
                <div id="loading-text-container">
                    <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_0.png">
                    <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_1.png">
                    <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_2.png">
                    <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_3.png">
                </div>
            </div>
        </div>
    </div> -->


    <!-- Script part -->
    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-canvas");
        var customOverlay = document.getElementById("custom-overlay");
        var characterBackground = document.getElementById("characted-background");
        var characterSprites = document.querySelectorAll('.character-sprite');
        var loadingHint = document.getElementById('load-text');
        var loadingTextSprites = document.querySelectorAll('.loading-text-sprite');
        var loadingText = document.getElementById("loader-text");
        var warningBanner = document.querySelector("#unity-warning");

        // Animating text update
        const phrases = [
            "Earning 10 000 bucks earns you 1 $BIZTY coin",
            "Improve objects and workers to increase your income",
            "Don't forget to collect passive income daily",
            "The more expensive the resources are, the more income you get",
            "Workers can get tired, walk up to them to wake them up",
            "Buildings break down from time to time, go over to fix them",
            "Open new businesses to generate even more income",
            "Tops in the leagues get rewards every day",
            "Businesses continue to generate passive income while you're in the game",
            "For every friend you invite, you will receive a reward and earn a percentage of their income"
        ];

        // let textIndex = 0;
        // function updateParagraph() {
        //     const randomIndex = Math.floor(Math.random() * phrases.length);
        //     loadingHint.textContent = phrases[randomIndex];
        // }
        // updateParagraph();
        // setInterval(updateParagraph, 5000);

        // // Animating character
        // let charactedIndex = 0;
        // function updateCharacterSprites() {
        //     characterSprites.forEach((sprite) => (sprite.style.display = 'none'));
        //     characterSprites[charactedIndex].style.display = 'block';
        //     charactedIndex = (charactedIndex + 1) % characterSprites.length;
        // }
        // setInterval(updateCharacterSprites, 250);

        // // Animating loading text
        // let loadingTextIndex = 0;
        // function updateLoadingTextSprites() {
        //     loadingTextSprites.forEach((sprite) => (sprite.style.display = 'none'));
        //     loadingTextSprites[loadingTextIndex].style.display = 'block';
        //     loadingTextIndex = (loadingTextIndex + 1) % loadingTextSprites.length;
        // }
        // setInterval(updateLoadingTextSprites, 500);

        // Logging to backend
        let userToken;
        let unityTokenReady = false;
        function lateLogin() {
            var app = app || {};
            var initData = window.Telegram.WebApp.initData;
            var initDataObj = { init_data: initData };
            var initDataJson = JSON.stringify(initDataObj);

            if (initDataJson === undefined) {
                console.log("Init data json is undefined");
            }

            app.postAuthRequest = function (authData, callback) {
                const url = "https://plankton-app-vzfoe.ondigitalocean.app/api/login";
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: initDataJson
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        userToken = data.token;
                        unityTokenReady = true;
                        if (callback) callback(null, data);
                    })
                    .catch(error => {
                        console.error("Error during authentication request:", error);
                        if (callback) callback(error, null);
                    });
            };

            app.postAuthRequest(function (error, response) {
                if (error) {
                    console.error("Error callback:", error);
                } else {
                    console.log("Success callback:", response);
                }
            });
        }
        lateLogin();

        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') div.style = 'background: red; padding: 10px;';
            else {
                if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                setTimeout(function () {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        };

        // Starting build
        var buildUrl = "Build";
        var loaderUrl = buildUrl + "/motchiBuild.loader.js";
        var config = {
            dataUrl: buildUrl + "/motchiBuild.data.unityweb",
            frameworkUrl: buildUrl + "/motchiBuild.framework.js.unityweb",
            codeUrl: buildUrl + "/motchiBuild.wasm.unityweb",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "motchi",
            productVersion: "1.0",
            showBanner: unityShowBanner,
        };

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            container.className = "unity-mobile";
            canvas.className = "unity-mobile";
        } else {
            canvas.style.width = "100%";
            canvas.style.height = "100%";
        }

        var myGameInstance = null;
        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
            }).then((unityInstance) => {
                myGameInstance = unityInstance;
                customOverlay.style.display = "flex";
                loadingText.style.display = "none";
            }).catch((message) => {
                alert(message);
            });
        }
        document.body.appendChild(script);
    </script>
</body>

</html>