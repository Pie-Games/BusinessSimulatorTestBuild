<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Biz Tycoon</title>
    <link rel="shortcut icon" href="TemplateData/sign.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes, maximum-scale=1, user-scalable=no">

    <!-- Socket server init -->
    <!-- <script src="https://cdn.socket.io/4.0.0/socket.io.js"></script> -->

    <!-- Ads initialization -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script>
        const AdController = window.Adsgram.init({
            blockId: "6544",
            debug: true,
            debugBannerType: "RewardedVideo"
        });
    </script>

    <script src="https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_ae25b59e"></script>
    <!-- <script>
        window.Sonar.show({ 
            adUnit: 'app_ae25b59e',
            loader: false,
        });
    </script> -->

    <!-- Ton initialization -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.12/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>

    <!-- Telegram init -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Раскрываем мини-апп при загрузке
        window.Telegram.WebApp.expand();
        function expandMiniApp() {
            console.log("Expanding Mini App...");
            if (window.TelegramWebviewProxy) {
                window.TelegramWebviewProxy.postEvent('web_app_expand', JSON.stringify({}));
                window.Telegram.WebApp.expand();
            } else if (window.parent) {
                window.parent.postEvent('web_app_expand');
            }
        }
        window.addEventListener('load', function () {
            setTimeout(expandMiniApp, 10);
        });
    </script>
</head>

<body>
<div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
</div>
<div id="custom-overlay">
    <img id="back-image" src="TemplateData/LoadingScreen/Cover.png">
    <div id="unity-loading-bar">
        <img id="unity-progress-bar-empty" src="TemplateData/LoadingScreen/SLOT.png">
        <img id="unity-progress-bar-full" src="TemplateData/LoadingScreen/Fill.png">
    </div>
    <div id="character-container">
        <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_0.png">
        <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_1.png">
        <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_2.png">
        <img class="loading-text-sprite" src="TemplateData/LoadingScreen/LOADING_3.png">
    </div>
</div>

<script>
    // ==============================
    // 1) Переменные окружения
    // ==============================
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var customOverlay = document.getElementById("custom-overlay");
    var loadingTextSprites = document.querySelectorAll('.loading-text-sprite');
    var progressBarFull = document.querySelector("#unity-progress-bar-full");

    let userToken;
    let unityTokenReady = false;

    // ==============================
    // 2) Авторизация (lateLogin)
    // ==============================
    function lateLogin() {
        var app = app || {};
        var initData = window.Telegram.WebApp.initData;
        var initDataObj = { init_data: initData };
        var initDataJson = JSON.stringify(initDataObj);

        if (initDataJson === undefined) {
            console.log("Init data json is undefined");
        }

        app.postAuthRequest = function (authData, callback) {
            const url = "https://plankton-app-vzfoe.ondigitalocean.app/api/login";
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: initDataJson
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    userToken = data.token;
                    unityTokenReady = true;
                    if (callback) callback(null, data);
                })
                .catch(error => {
                    console.error("Error during authentication request:", error);
                    if (callback) callback(error, null);
                });
        };

        app.postAuthRequest(function (error, response) {
            if (error) {
                console.error("Error callback:", error);
            } else {
                console.log("Success callback:", response);
            }
        });
    }
    lateLogin();

    // ==============================
    // 3) Предзагрузка бандла локации
    // ==============================
    async function preloadLocationBundle(lastLocation) {
        try {
            // 3.1 Загрузка catalog.json
            const catalogUrl = "https://biztycoongame.xyz/StreamingAssets/aa/catalog.json";
            const catalogRes = await fetch(catalogUrl);
            if (!catalogRes.ok) {
                console.warn("Не удалось загрузить catalog.json:", catalogRes.statusText);
                return;
            }
            const catalogData = await catalogRes.json();

            // 3.2 Ищем URL бандла, в котором есть, например: "location_kebab_assets_all_"
            // Если lastLocation = "kebab", то ищем "location_kebab_assets_all_"
            const searchFragment = "location_" + lastLocation.toLowerCase() + "_assets_all_";
            const matchedUrl = catalogData.m_InternalIds.find(x => x.includes(searchFragment));
            if (!matchedUrl) {
                console.warn("Не нашли URL для локации:", lastLocation, "в catalog.json");
                return;
            }

            // 3.3 Предзагрузка (fetch) бандла
            console.log("Предзагружаю бандл:", matchedUrl);
            const resp = await fetch(matchedUrl);
            if (!resp.ok) {
                console.warn("Fetch bundle error:", resp.statusText);
            } else {
                console.log(`Бандл локации '${lastLocation}' предзагружен в кэш.`);
            }
        } catch(e) {
            console.error("Ошибка в preloadLocationBundle:", e);
        }
    }

    // ==============================
    // 4) Запуск Unity (с предзагрузкой)
    // ==============================
    async function initAndStartUnity() {
        // 4.1 Узнаём last_location c вашего бэка
        let lastLocation = "farm"; // по умолчанию
        try {
            // Замените URL ниже на ваш реальный маршрут
            const userResp = await fetch("https://plankton-app-vzfoe.ondigitalocean.app/api/user/get");
            if (userResp.ok) {
                const userData = await userResp.json();
                if (userData && userData.last_location) {
                    lastLocation = userData.last_location;
                }
                console.log("С бэка last_location =", lastLocation);
            } else {
                console.warn("Не удалось получить last_location:", userResp.statusText);
            }
        } catch (err) {
            console.warn("Ошибка /user/get:", err);
        }

        // 4.2 Предзагрузка бандла локации (если нашли в catalog.json)
        await preloadLocationBundle(lastLocation);

        // 4.3 Проверка окружения (Telegram / мобильный)
        var userLang = navigator.language || navigator.userLanguage;
        var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        var isTelegram = (typeof window.Telegram !== 'undefined' && Telegram.WebApp);

        if (!isTelegram) { // For local tests
            if (userLang.toLowerCase().includes("ru")) {
                alert("Пожалуйста, откройте игру в Telegram на телефоне");
            } else {
                alert("Please open the game in Telegram on your phone");
            }
            document.getElementById("unity-container").style.display = 'none';
            return;
        }

        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            container.className = "unity-mobile";
            canvas.className = "unity-mobile";
        } else {
            canvas.style.width = "100%";
            canvas.style.height = "100%";
        }

        loadingBar.style.display = "block";

        // 4.4 Подключаем скрипт для запуска Unity
        var buildUrl = "Build";
        var loaderUrl = buildUrl + "/02cbca31a0c1e949f10c9b2b7b755307.loader.js";
        var config = {
            dataUrl: buildUrl + "/99cbeb5f4f793c7e3b4a430bdc337ae5.data.unityweb",
            frameworkUrl: buildUrl + "/4c7795463a285bc08a001a6c244fe338.framework.js.unityweb",
            codeUrl: buildUrl + "/da83f5ac9bc67d5c406ea7bcb5d618a4.wasm.unityweb",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "motchi",
            productVersion: "1.0",
        };

        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                progressBarFull.style.width = 100 * progress + "%";
            }).then((instance) => {
                window.Telegram.WebApp.enableClosingConfirmation();
                console.log("Unity запущен");
            }).catch((message) => {
                alert(message);
            });
        };
        document.body.appendChild(script);
    }

    // ==============================
    // 5) Запуск всей логики
    // ==============================
    initAndStartUnity();
</script>
</body>
</html>
